<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>çŒœç‡ˆè¬éŠæˆ²</title>
  <style>
    body { font-family: "Microsoft JhengHei", sans-serif; text-align: center; background-color: #fff8e1; color: #333; }
    #game-container { margin-top: 50px; padding: 20px; border: 2px solid #f57c00; border-radius: 10px; background-color: #fff3e0; display: inline-block; }
    input, button { margin-top: 10px; padding: 8px; font-size: 16px; }
  </style>
</head>
<body>
  <h1>çŒœç‡ˆè¬éŠæˆ²</h1>
  <div id="game-container">
    <div id="id-section">
      <p>è«‹è¼¸å…¥ä½ çš„ç©å®¶ IDï¼š</p>
      <input type="text" id="playerId" placeholder="ç©å®¶ID">
      <button id="startBtn">é–‹å§‹éŠæˆ²</button>
    </div>

    <div id="quiz-section" style="display:none;">
      <p id="riddle">é¡Œç›®è¼‰å…¥ä¸­...</p>
      <input type="text" id="answer" placeholder="è¼¸å…¥ä½ çš„ç­”æ¡ˆ">
      <button id="submit">æäº¤ç­”æ¡ˆ</button>
      <p id="feedback"></p>
      <p id="progress"></p>
    </div>

    <div id="result-section" style="display:none;">
      <h2>éŠæˆ²çµæŸï¼</h2>
      <p id="final-score"></p>
    </div>
  </div>

  <script>
    const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTML5xH0Jasxdab6Lp73qAeg26JjOo5V7eMFN3ETNQ0LOzYl3m28XPyJ72-r0Pg8YbtT3rmPl9lbdVs/pub?output=csv";
    const scriptUrl = "https://script.google.com/macros/s/AKfycbwKY6CcPrO9N9pFhoDklL6hlo5E5r1MGGzDjJv4dtiRkkYccl8AXr-g216PJwMJudWbkQ/exec";

    let riddles = [];
    let currentIndex = 0;
    let score = 0;
    let playerId = "";
    let userIp = "";

    // å–å¾—ä½¿ç”¨è€… IP
    fetch("https://api.ipify.org?format=json")
      .then(res => res.json())
      .then(data => { userIp = data.ip; });

    // é–‹å§‹éŠæˆ²
    document.getElementById("startBtn").addEventListener("click", () => {
      playerId = document.getElementById("playerId").value.trim();
      if (playerId === "") { alert("è«‹è¼¸å…¥ç©å®¶ IDï¼"); return; }
      document.getElementById("id-section").style.display = "none";
      document.getElementById("quiz-section").style.display = "block";

      fetch(sheetUrl)
        .then(res => res.text())
        .then(csv => {
          const rows = csv.trim().split(/\r?\n/).map(r => r.split(","));
          riddles = rows.slice(1).map(row => ({ question: row[0], answer: row[1] }));
          riddles = riddles.slice(0, 10); // åªå–å‰10é¡Œ
          loadRiddle();
        });
    });

    function loadRiddle() {
      document.getElementById("riddle").textContent = riddles[currentIndex].question;
      document.getElementById("progress").textContent = `ç¬¬ ${currentIndex+1} é¡Œ / å…± ${riddles.length} é¡Œ`;
      document.getElementById("answer").value = "";
      document.getElementById("feedback").textContent = "";
    }

    document.getElementById("submit").addEventListener("click", () => {
      const userAnswer = document.getElementById("answer").value.trim();
      const feedback = document.getElementById("feedback");

      if (userAnswer === riddles[currentIndex].answer) {
        feedback.textContent = "ç­”å°äº†ï¼ğŸ‰";
        score++;
      } else {
        feedback.textContent = `ç­”éŒ¯äº†ï½ æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š${riddles[currentIndex].answer}`;
      }

      currentIndex++;
      if (currentIndex < riddles.length) {
        setTimeout(loadRiddle, 1500);
      } else {
        showResult();
      }
    });

    function showResult() {
      document.getElementById("quiz-section").style.display = "none";
      document.getElementById("result-section").style.display = "block";
      document.getElementById("final-score").textContent = `ç©å®¶ ${playerId} çš„åˆ†æ•¸æ˜¯ï¼š${score} / ${riddles.length}`;

      // æŠŠè³‡æ–™é€åˆ° Google Apps Script
      fetch(scriptUrl, {
        method: "POST",
        body: JSON.stringify({ playerId: playerId, score: score, ip: userIp })
      });
    }
  </script>
</body>
</html>